name: FitTrack Comprehensive Test Suite

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'fittrack/**'
      - '.github/workflows/fittrack_test_suite.yml'
  pull_request:
    branches:
      - main
      - 'feature/**'  # Run on PRs to feature branches (task‚Üífeature)
      - 'bug/**'      # Run on PRs to bug branches (task‚Üíbug)
    paths:
      - 'fittrack/**'
      - '.github/workflows/fittrack_test_suite.yml'

# Required permissions for PR comments and test reports
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Parallel test execution for faster feedback
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 3.35.1
        cache: true
        
    - name: Install dependencies
      run: |
        cd fittrack
        flutter pub get
        flutter pub deps
        
    - name: Generate mocks and build artifacts
      run: |
        cd fittrack
        dart pub run build_runner build --delete-conflicting-outputs --verbose
        
    - name: Verify mock generation
      run: |
        cd fittrack
        echo "Checking for generated mock files..."
        find test -name "*.mocks.dart" | head -10 || echo "No mock files found"
        
    - name: Run static analysis
      run: |
        cd fittrack
        flutter analyze lib/ --no-fatal-warnings | tee analyze_output.txt
        # Check if there are any actual ERROR level issues
        if grep -q "error ‚Ä¢" analyze_output.txt; then
          echo "ERROR level issues found - failing build"
          exit 1
        else
          echo "Only INFO/WARNING level issues found - continuing build"
          exit 0
        fi
        
    - name: Run unit tests with coverage
      run: |
        cd fittrack
        flutter test test/models/ test/services/ test/providers/ \
          --coverage
          
    - name: Upload unit test coverage
      uses: codecov/codecov-action@v3
      with:
        file: fittrack/coverage/lcov.info
        flags: unit-tests
        name: unit-test-coverage

  widget-tests:
    name: Widget Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 3.35.1
        cache: true
        
    - name: Install dependencies
      run: |
        cd fittrack
        flutter pub get
        flutter pub deps
        
    - name: Generate mocks and build artifacts
      run: |
        cd fittrack
        dart pub run build_runner build --delete-conflicting-outputs --verbose
        
    - name: Run widget tests
      run: |
        cd fittrack
        # Run widget tests with better error handling
        flutter test test/widgets/ test/screens/ \
          --timeout=60s \
          --reporter=github
          
    - name: Check widget test results
      run: |
        cd fittrack
        echo "Widget test execution completed"
          

  integration-tests:
    name: Integration Tests (Android)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Free Disk Space for Android Emulator
      run: |
        echo "=== Disk space BEFORE cleanup ==="
        df -h
        echo ""

        echo "=== Removing unused components ==="
        # Remove .NET runtime (~2.7GB)
        sudo rm -rf /usr/share/dotnet

        # Remove Haskell (~5.3GB)
        sudo rm -rf /opt/ghc

        # Remove CodeQL (~5GB)
        sudo rm -rf /opt/hostedtoolcache/CodeQL

        # Remove large misc packages (~4GB)
        # Note: Keep NDK for caching - commented out to allow NDK caching to work
        # sudo rm -rf /usr/local/lib/android/sdk/ndk
        sudo rm -rf /usr/local/share/boost

        # Clean Docker system (~4GB)
        sudo docker system prune -af

        # Clean apt cache (~1GB)
        sudo apt-get clean

        echo ""
        echo "=== Disk space AFTER cleanup ==="
        df -h
        echo ""
        echo "‚úÖ Cleanup complete"

    - name: Setup Java for Android
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        target: google_apis
        arch: x86_64
        profile: Nexus 6
        
    - name: Cache Gradle dependencies and NDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.android/build-cache
          /usr/local/lib/android/sdk/ndk
        key: ${{ runner.os }}-gradle-ndk-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-ndk-
          ${{ runner.os }}-gradle-
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 3.35.1
        cache: true
        
    - name: Setup Node.js for Firebase CLI
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: Install dependencies
      run: |
        cd fittrack
        flutter pub get
        flutter pub deps
        
    - name: Generate mocks and build artifacts
      run: |
        cd fittrack
        dart pub run build_runner build --delete-conflicting-outputs --verbose
        
    - name: Start Firebase emulators
      run: |
        cd fittrack
        # Start emulators without project flag to load custom firestore.rules
        # This ensures our security rules are applied during integration tests
        # The emulator will use the project from .firebaserc (fitness-app-8505e)
        firebase emulators:start --only auth,firestore &
        echo $! > emulator.pid
        echo "‚úÖ Firebase emulators started with custom security rules"
        
    - name: Wait for emulators
      run: |
        echo "‚è≥ Waiting for Firebase emulators to start..."
        sleep 15

        # Wait for emulators to be ready with retry logic
        for i in {1..30}; do
          echo "üîç Checking emulator availability (attempt $i/30)..."

          # Check if both ports are listening
          if nc -z localhost 8080 && nc -z localhost 9099; then
            echo "‚úÖ Both Firebase emulators are responding on their ports"
            break
          fi

          if [ $i -eq 30 ]; then
            echo "‚ö†Ô∏è  Emulators not ready after 30 attempts, continuing anyway"
          else
            sleep 2
          fi
        done

        # Final verification with proper endpoints
        echo "üîç Testing Firestore emulator endpoint..."
        curl -f http://localhost:8080/v1/projects/demo-project/databases || echo "‚ö†Ô∏è  Firestore endpoint not ready"
        echo "‚úÖ Firestore emulator: localhost:8080"

        echo "üîç Testing Auth emulator endpoint..."
        curl -f http://localhost:9099/identitytoolkit.googleapis.com/v1/projects/demo-project || echo "‚ö†Ô∏è  Auth endpoint not ready"
        echo "‚úÖ Auth emulator: localhost:9099"

        echo "üì± Android emulator will access via 10.0.2.2:8080 and 10.0.2.2:9099"
        echo "‚úÖ Firebase emulators ready for integration testing"
        
        echo "Firebase emulator setup completed - proceeding with tests"
        
    - name: Run integration tests
      run: |
        cd fittrack
        # Note: Cascade delete integration test runs with Android emulator below
        echo "Cascade delete integration test will run with Android emulator tests"
          
    - name: Enable KVM group permissions
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
        
    - name: Run Android Integration Test
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        target: google_apis
        arch: x86_64
        profile: pixel_2
        ram-size: 1536M
        heap-size: 256M
        disk-size: 2048M
        avd-name: test
        disable-animations: true
        emulator-boot-timeout: 900
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
        script: |
          echo "üîç Starting Android Integration Test..."
          echo "üì± Flutter and emulator info:"
          flutter --version
          flutter devices -v
          
          echo "üîó Verifying Firebase emulator connectivity:"
          curl -f http://localhost:8080/ && echo "‚úÖ Firestore emulator responding" || echo "‚ùå Firestore emulator not responding"
          curl -f http://localhost:9099/ && echo "‚úÖ Auth emulator responding" || echo "‚ùå Auth emulator not responding"
          
          echo "‚è∞ Warming up Android emulator before tests..."
          adb devices -l
          adb -s emulator-5554 shell pm list packages | head -5 || echo "Emulator warming up..."
          sleep 10
          
          # Verify emulator is responsive
          echo "üîç Checking emulator health..."
          adb -s emulator-5554 shell echo "emulator-ready" 2>/dev/null || (echo "‚ö†Ô∏è  Emulator not responding, waiting longer..." && sleep 15)
          
          echo "üöÄ Running integration tests on Android with flutter drive..."

          echo "Running analytics integration test..."
          # First test needs longer timeout to include APK build time (Gradle + NDK download)
          # Subsequent tests reuse the built APK and only need time for test execution
          timeout 1800 bash -c 'cd fittrack && flutter drive --driver=test_driver/integration_test.dart --target=integration_test/analytics_integration_test.dart --device-id=emulator-5554'

          echo "Running workout creation integration test..."
          timeout 900 bash -c 'cd fittrack && flutter drive --driver=test_driver/integration_test.dart --target=integration_test/workout_creation_integration_test.dart --device-id=emulator-5554'

          echo "Running complete workflow integration test..."
          timeout 900 bash -c 'cd fittrack && flutter drive --driver=test_driver/integration_test.dart --target=integration_test/enhanced_complete_workflow_test.dart --device-id=emulator-5554'

          echo "Running cascade delete integration test..."
          timeout 900 bash -c 'cd fittrack && flutter drive --driver=test_driver/integration_test.dart --target=integration_test/firestore_cascade_delete_integration_test.dart --device-id=emulator-5554'

    - name: Stop Firebase emulators
      if: always()
      run: |
        cd fittrack
        if [ -f emulator.pid ]; then
          kill $(cat emulator.pid) || true
          rm emulator.pid
        fi
        pkill -f "firebase" || true
        pkill -f "java.*firestore" || true
      

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 3.35.1
        cache: true
        
    - name: Install dependencies
      run: |
        cd fittrack
        flutter pub get
        flutter pub deps
        
    - name: Generate mocks and build artifacts
      run: |
        cd fittrack
        dart pub run build_runner build --delete-conflicting-outputs --verbose
        
    - name: Run performance tests
      run: |
        cd fittrack
        flutter test test/models/analytics_edge_cases_test.dart \
          --reporter=github
          

  # Enhanced tests with comprehensive coverage
  enhanced-tests:
    name: Enhanced Test Suite
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 3.35.1
        cache: true
        
    - name: Setup Node.js for Firebase CLI
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: Install dependencies
      run: |
        cd fittrack
        flutter pub get
        flutter pub deps
        
    - name: Generate mocks and build artifacts
      run: |
        cd fittrack
        dart pub run build_runner build --delete-conflicting-outputs --verbose
        
    - name: Run enhanced unit tests
      run: |
        cd fittrack
        # Run enhanced model tests first (most reliable)
        flutter test test/models/enhanced_program_test.dart test/models/enhanced_exercise_test.dart \
          --coverage \
          --timeout=60s \
          --reporter=github
          
    - name: Start Firebase emulators for enhanced integration
      run: |
        cd fittrack
        firebase emulators:start --only auth,firestore &
        echo $! > emulator.pid
        sleep 15
        
    - name: Run enhanced integration tests
      run: |
        cd fittrack
        # Run simplified integration tests
        flutter test test/screens/enhanced_create_program_screen_test.dart test/models/program_model_validation_test.dart \
          --timeout=120s \
          --reporter=github
          
    - name: Stop emulators
      if: always()
      run: |
        cd fittrack
        if [ -f emulator.pid ]; then
          kill $(cat emulator.pid) || true
          rm emulator.pid
        fi
        pkill -f "firebase" || true
        pkill -f "java.*firestore" || true

  # Aggregate results and generate reports
  test-summary:
    name: Test Summary Report
    runs-on: ubuntu-latest
    needs: [unit-tests, widget-tests, integration-tests, performance-tests, enhanced-tests]
    if: github.event_name == 'pull_request' && always() # Run even if some tests fail
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check test results
      run: echo "Checking test results from previous jobs"
      
    - name: Generate test summary
      run: |
        echo "# FitTrack Test Suite Results" > test-summary.md
        echo "" >> test-summary.md
        echo "## Test Execution Summary" >> test-summary.md
        echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> test-summary.md
        echo "- Widget Tests: ${{ needs.widget-tests.result }}" >> test-summary.md
        echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> test-summary.md
        echo "- Performance Tests: ${{ needs.performance-tests.result }}" >> test-summary.md
        echo "- Enhanced Tests: ${{ needs.enhanced-tests.result }}" >> test-summary.md
        echo "" >> test-summary.md
        echo "## Coverage Report" >> test-summary.md
        echo "Coverage reports available in artifacts." >> test-summary.md
        
    - name: Comment test summary on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test-summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  all-tests-passed:
    name: All Tests Status
    runs-on: ubuntu-latest
    needs: [unit-tests, widget-tests, integration-tests, performance-tests, enhanced-tests, security-checks]
    if: github.event_name == 'pull_request' && always()

    steps:
    - name: Check all test results
      run: |
        echo "Unit Tests: ${{ needs.unit-tests.result }}"
        echo "Widget Tests: ${{ needs.widget-tests.result }}"
        echo "Integration Tests: ${{ needs.integration-tests.result }}"
        echo "Performance Tests: ${{ needs.performance-tests.result }}"
        echo "Enhanced Tests: ${{ needs.enhanced-tests.result }}"
        echo "Security Checks: ${{ needs.security-checks.result }}"

        # Fail if any critical test failed
        if [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
           [[ "${{ needs.security-checks.result }}" != "success" ]]; then
          echo "‚ùå Critical tests failed"
          exit 1
        fi

        # Warn but don't fail on integration/widget test failures
        if [[ "${{ needs.integration-tests.result }}" != "success" ]] || \
           [[ "${{ needs.widget-tests.result }}" != "success" ]]; then
          echo "‚ö†Ô∏è  Some tests failed but not blocking"
        fi

        echo "‚úÖ All critical tests passed"

# Security scanning and dependency checks
  security-checks:
    name: Security and Dependency Checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 3.35.1
        
    - name: Run dependency audit
      run: |
        cd fittrack
        flutter pub deps --json | jq '.packages[] | select(.kind != "direct") | .name' | sort | uniq
        
    - name: Check for known vulnerabilities
      run: |
        cd fittrack
        # Check for outdated packages
        flutter pub outdated --json
        
    - name: Validate Firebase configuration
      run: |
        cd fittrack
        # Verify Firebase configuration is secure
        test -f firebase.json || exit 1
        test -f firestore.rules || exit 1
