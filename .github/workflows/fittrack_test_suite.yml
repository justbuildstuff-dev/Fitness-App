name: FitTrack Comprehensive Test Suite

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'fittrack/**'
      - '.github/workflows/fittrack_test_suite.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'fittrack/**'
      - '.github/workflows/fittrack_test_suite.yml'

jobs:
  # Parallel test execution for faster feedback
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 3.35.1
        cache: true
        
    - name: Install dependencies
      run: |
        cd fittrack
        flutter pub get
        dart pub run build_runner build --delete-conflicting-outputs
        
    - name: Run static analysis
      run: |
        cd fittrack
        flutter analyze lib/ --no-fatal-warnings || exit 0
        
    - name: Run unit tests with coverage
      run: |
        cd fittrack
        flutter test test/models/ test/services/ test/providers/ \
          --coverage
          
    - name: Upload unit test coverage
      uses: codecov/codecov-action@v3
      with:
        file: fittrack/coverage/lcov.info
        flags: unit-tests
        name: unit-test-coverage

  widget-tests:
    name: Widget Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 3.35.1
        cache: true
        
    - name: Install dependencies
      run: |
        cd fittrack
        flutter pub get
        dart pub run build_runner build --delete-conflicting-outputs
        
    - name: Run widget tests
      run: |
        cd fittrack
        flutter test test/screens/ test/widgets/ \
          --reporter=compactwidget.json
          

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 3.35.1
        cache: true
        
    - name: Setup Node.js for Firebase CLI
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: Install dependencies
      run: |
        cd fittrack
        flutter pub get
        dart pub run build_runner build --delete-conflicting-outputs
        
    - name: Start Firebase emulators
      run: |
        cd fittrack
        firebase emulators:start --only auth,firestore --detached
        
    - name: Wait for emulators
      run: |
        echo "Waiting for emulators to start..."
        sleep 10
        curl -f http://localhost:8080/ || exit 1
        curl -f http://localhost:9099/ || exit 1
        
    - name: Run integration tests
      run: |
        cd fittrack
        flutter test test/integration/ \
          --reporter=compactintegration.json
          
    - name: Stop Firebase emulators
      if: always()
      run: firebase emulators:kill
      

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 3.35.1
        cache: true
        
    - name: Install dependencies
      run: |
        cd fittrack
        flutter pub get
        dart pub run build_runner build --delete-conflicting-outputs
        
    - name: Run performance tests
      run: |
        cd fittrack
        flutter test test/performance/ \
          --reporter=compactperformance.json
          

  # Enhanced tests with comprehensive coverage
  enhanced-tests:
    name: Enhanced Test Suite
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 3.35.1
        cache: true
        
    - name: Setup Node.js for Firebase CLI
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: Install dependencies
      run: |
        cd fittrack
        flutter pub get
        dart pub run build_runner build --delete-conflicting-outputs
        
    - name: Run enhanced unit tests
      run: |
        cd fittrack
        flutter test test/models/enhanced_*.dart test/services/enhanced_*.dart \
          --coverage \
          --reporter=verbose
          
    - name: Start Firebase emulators for enhanced integration
      run: |
        cd fittrack
        firebase emulators:start --only auth,firestore --detached
        sleep 10
        
    - name: Run enhanced integration tests
      run: |
        cd fittrack
        flutter test test/integration/enhanced_*.dart \
          --reporter=verbose
          
    - name: Stop emulators
      if: always()
      run: firebase emulators:kill

  # Aggregate results and generate reports
  test-summary:
    name: Test Summary Report
    runs-on: ubuntu-latest
    needs: [unit-tests, widget-tests, integration-tests, performance-tests, enhanced-tests]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check test results
      run: echo "Checking test results from previous jobs"
      
    - name: Generate test summary
      run: |
        echo "# FitTrack Test Suite Results" > test-summary.md
        echo "" >> test-summary.md
        echo "## Test Execution Summary" >> test-summary.md
        echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> test-summary.md
        echo "- Widget Tests: ${{ needs.widget-tests.result }}" >> test-summary.md
        echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> test-summary.md
        echo "- Performance Tests: ${{ needs.performance-tests.result }}" >> test-summary.md
        echo "- Enhanced Tests: ${{ needs.enhanced-tests.result }}" >> test-summary.md
        echo "" >> test-summary.md
        echo "## Coverage Report" >> test-summary.md
        echo "Coverage reports available in artifacts." >> test-summary.md
        
    - name: Comment test summary on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test-summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

# Security scanning and dependency checks
  security-checks:
    name: Security and Dependency Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 3.35.1
        
    - name: Run dependency audit
      run: |
        cd fittrack
        flutter pub deps --json | jq '.packages[] | select(.kind != "direct") | .name' | sort | uniq
        
    - name: Check for known vulnerabilities
      run: |
        cd fittrack
        # Check for outdated packages
        flutter pub outdated --json
        
    - name: Validate Firebase configuration
      run: |
        cd fittrack
        # Verify Firebase configuration is secure
        test -f firebase.json || exit 1
        test -f firestore.rules || exit 1