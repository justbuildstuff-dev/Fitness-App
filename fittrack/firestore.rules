rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------
    // Helper functions
    // -----------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isString(v) { return v is string; }
    function isNumber(v) { return v is int || v is float; }
    function isTimestamp(v) { return v is timestamp; }
    function isBoolean(v) { return v is bool; }

    // Allowed exercise types
    // adjust as needed if you expand types in future
    function allowedExerciseType(t) {
      return t == 'strength' || t == 'cardio' || t == 'bodyweight' || t == 'custom' || t == 'time-based';
    }

    // -----------------------
    // Top-level user node
    // All user data is stored under users/{userId}/...
    // -----------------------
    match /users/{userId} {

      // Owner or admin can read user profile
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin(); // admins may list users (support only)

      // Creation: only the authenticated user may create their own profile document
      allow create: if isSignedIn() && request.auth.uid == userId && validUserProfile(request.resource.data);

      // Updates: owner or admin
      allow update: if (isOwner(userId) || isAdmin()) && validUserProfile(request.resource.data);

      // Deletion: admin only (safer than letting users delete their top-level node)
      allow delete: if isAdmin();

      // --- Programs subcollection ---
      match /programs/{programId} {
        allow get: if isOwner(userId) || isAdmin();
        allow list: if isOwner(userId) || isAdmin();

        // Create only allowed for owner; enforce userId field matches auth uid
        allow create: if isOwner(userId)
                      && request.resource.data.userId == request.auth.uid
                      && validProgram(request.resource.data);

        // Updates & deletes allowed for owner/admin
        allow update: if (isOwner(userId) || isAdmin())
                      && validProgram(request.resource.data);
        // Delete: verify the existing document belongs to the authenticated user
        allow delete: if (isOwner(userId) || isAdmin())
                      && resource.data.userId == request.auth.uid;

        // Weeks under programs
        match /weeks/{weekId} {
          allow get, list: if isOwner(userId) || isAdmin();

          allow create: if isOwner(userId)
                        && request.resource.data.userId == request.auth.uid
                        && validWeek(request.resource.data);

          allow update: if (isOwner(userId) || isAdmin())
                        && validWeek(request.resource.data);
          // Delete: verify the existing document belongs to the authenticated user
          allow delete: if (isOwner(userId) || isAdmin())
                        && resource.data.userId == request.auth.uid;

          // Workouts under weeks
          match /workouts/{workoutId} {
            allow get, list: if isOwner(userId) || isAdmin();

            allow create: if isOwner(userId)
                          && request.resource.data.userId == request.auth.uid
                          && validWorkout(request.resource.data);

            allow update: if (isOwner(userId) || isAdmin())
                          && validWorkout(request.resource.data);
            // Delete: verify the existing document belongs to the authenticated user
            allow delete: if (isOwner(userId) || isAdmin())
                          && resource.data.userId == request.auth.uid;

            // Exercises under workouts
            match /exercises/{exerciseId} {
              allow get, list: if isOwner(userId) || isAdmin();

              allow create: if isOwner(userId)
                            && request.resource.data.userId == request.auth.uid
                            && validExercise(request.resource.data);

              allow update: if (isOwner(userId) || isAdmin())
                            && validExercise(request.resource.data);
              // Delete: verify the existing document belongs to the authenticated user
              allow delete: if (isOwner(userId) || isAdmin())
                            && resource.data.userId == request.auth.uid;

              // Sets under exercises
              match /sets/{setId} {
                allow get, list: if isOwner(userId) || isAdmin();

                allow create: if isOwner(userId)
                              && request.resource.data.userId == request.auth.uid
                              && validSet(request.resource.data);

                allow update: if (isOwner(userId) || isAdmin())
                              && validSet(request.resource.data);
                // Delete: verify the existing document belongs to the authenticated user
                allow delete: if (isOwner(userId) || isAdmin())
                              && resource.data.userId == request.auth.uid;
              } // sets
            } // exercises
          } // workouts
        } // weeks
      } // programs

      // ---- Duplication requests: trigger for Cloud Function ----
      // Pattern: users/{userId}/duplicationRequests/{requestId}
      // Clients create a request doc (owned by same user); Cloud Function watches it and processes duplication.
      match /duplicationRequests/{requestId} {
        // Creation allowed only for owner and only if request contains required fields and userId matches
        allow create: if isOwner(userId)
                      && request.resource.data.userId == request.auth.uid
                      && validDuplicationRequest(request.resource.data);

        // Owner can read status of their own requests; admins can list for support
        allow get: if isOwner(userId) || isAdmin();
        allow list: if isOwner(userId) || isAdmin();

        // Prevent arbitrary updates from client; duplication function (admin SDK) should update status
        allow update: if isAdmin(); // only server/admin can update
        allow delete: if isAdmin(); // only server/admin can cleanup
      }

      // ---- Duplication logs (audit) ----
      // Cloud Function writes to duplicationLogs; clients should not write
      match /duplicationLogs/{logId} {
        allow create: if isAdmin(); // only server should create logs via admin SDK
        allow get: if isOwner(userId) || isAdmin();
        allow list: if isAdmin();
        allow update, delete: if isAdmin();
      }
    } // end users

    // -----------------------
    // Validators for document shapes
    // Keep these functions concise; firestore rule evaluations should be efficient.
    // -----------------------
    function validUserProfile(data) {
      return (data.displayName == null || isString(data.displayName) && data.displayName.size() <= 100)
        && (data.email == null || isString(data.email))
        && (data.createdAt != null && isTimestamp(data.createdAt))
        && (data.lastLogin == null || isTimestamp(data.lastLogin))
        && (data.settings == null || data.settings is map);
    }

    function validProgram(data) {
      return (data.name != null && isString(data.name) && data.name.size() <= 100)
        && (data.description == null || isString(data.description) && data.description.size() <= 500)
        && (data.createdAt != null && isTimestamp(data.createdAt))
        && (data.updatedAt != null && isTimestamp(data.updatedAt))
        && (data.userId != null && isString(data.userId))
        && (data.isArchived == null || isBoolean(data.isArchived));
    }

    function validWeek(data) {
      return (data.name != null && isString(data.name))
        && (data.order != null && isNumber(data.order) && data.order >= 0)
        && (data.notes == null || isString(data.notes))
        && (data.createdAt != null && isTimestamp(data.createdAt))
        && (data.updatedAt != null && isTimestamp(data.updatedAt))
        && (data.userId != null && isString(data.userId))
        && (data.programId != null && isString(data.programId));
    }

    function validWorkout(data) {
      return (data.name != null && isString(data.name) && data.name.size() <= 200)
        && (data.orderIndex != null && isNumber(data.orderIndex))
        && (data.dayOfWeek == null || (isNumber(data.dayOfWeek) && data.dayOfWeek >= 1 && data.dayOfWeek <= 7))
        && (data.notes == null || isString(data.notes))
        && (data.createdAt != null && isTimestamp(data.createdAt))
        && (data.updatedAt != null && isTimestamp(data.updatedAt))
        && (data.userId != null && isString(data.userId))
        && (data.weekId != null && isString(data.weekId))
        && (data.programId != null && isString(data.programId));
    }

    function validExercise(data) {
      return (data.name != null && isString(data.name) && data.name.size() <= 200)
        && (data.exerciseType != null && isString(data.exerciseType) && allowedExerciseType(data.exerciseType))
        && (data.orderIndex != null && isNumber(data.orderIndex))
        && (data.notes == null || isString(data.notes))
        && (data.createdAt != null && isTimestamp(data.createdAt))
        && (data.updatedAt != null && isTimestamp(data.updatedAt))
        && (data.userId != null && isString(data.userId))
        && (data.workoutId != null && isString(data.workoutId))
        && (data.weekId != null && isString(data.weekId))
        && (data.programId != null && isString(data.programId));
    }

    function validSet(data) {
      // at least one of reps/duration/distance must be present
      let hasMetric = (data.reps != null) || (data.duration != null) || (data.distance != null);

      return (data.setNumber != null && isNumber(data.setNumber) && data.setNumber >= 0)
        && hasMetric
        && (data.reps == null || isNumber(data.reps) && data.reps >= 0)
        && (data.weight == null || isNumber(data.weight) && data.weight >= 0)
        && (data.duration == null || isNumber(data.duration) && data.duration >= 0)
        && (data.distance == null || isNumber(data.distance) && data.distance >= 0)
        && (data.restTime == null || isNumber(data.restTime) && data.restTime >= 0)
        && (data.checked == null || isBoolean(data.checked))
        && (data.notes == null || isString(data.notes))
        && (data.createdAt != null && isTimestamp(data.createdAt))
        && (data.updatedAt != null && isTimestamp(data.updatedAt))
        && (data.userId != null && isString(data.userId))
        && (data.exerciseId != null && isString(data.exerciseId))
        && (data.workoutId != null && isString(data.workoutId))
        && (data.weekId != null && isString(data.weekId))
        && (data.programId != null && isString(data.programId));
    }

    function validDuplicationRequest(data) {
      // require minimal shape: userId, programId (optional), weekId (optional), requestTs
      return (data.userId == request.auth.uid)
        && (data.requestTs is timestamp)
        && (data.programId == null || isString(data.programId))
        && (data.weekId == null || isString(data.weekId))
        && (data.entityType == null || (data.entityType in ['program', 'week', 'workout', 'exercise']));
    }

  } // end match /databases
}
